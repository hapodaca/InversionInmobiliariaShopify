name: Sync Shopify Theme to GitHub

on:
  # Ejecutar autom√°ticamente cada 6 horas
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

  # Permitir ejecuci√≥n manual desde GitHub
  workflow_dispatch:

jobs:
  sync-theme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download theme from Shopify
        env:
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_CLI_TOKEN }}
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          THEME_ID: ${{ secrets.SHOPIFY_THEME_ID }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import urllib.request
          import urllib.parse
          import base64
          from pathlib import Path

          store = os.environ['SHOPIFY_STORE'].replace('.myshopify.com', '')
          token = os.environ['SHOPIFY_ACCESS_TOKEN']
          theme_id = os.environ['THEME_ID']

          base_url = f"https://{store}.myshopify.com/admin/api/2024-01"
          headers = {
              'X-Shopify-Access-Token': token,
              'Content-Type': 'application/json'
          }

          print("üîç Obteniendo lista de archivos del tema...")

          # Get list of assets
          req = urllib.request.Request(
              f"{base_url}/themes/{theme_id}/assets.json",
              headers=headers
          )

          try:
              with urllib.request.urlopen(req) as response:
                  data = json.loads(response.read().decode())
                  assets = data['assets']
                  print(f"‚úÖ Encontrados {len(assets)} archivos")

                  for i, asset in enumerate(assets):
                      key = asset['key']
                      print(f"üì• [{i+1}/{len(assets)}] {key}")

                      # Get individual asset
                      asset_url = f"{base_url}/themes/{theme_id}/assets.json?asset[key]={urllib.parse.quote(key)}"
                      asset_req = urllib.request.Request(asset_url, headers=headers)

                      try:
                          with urllib.request.urlopen(asset_req) as asset_response:
                              asset_data = json.loads(asset_response.read().decode())
                              content = asset_data['asset']

                              # Create directory if needed
                              file_path = Path(key)
                              file_path.parent.mkdir(parents=True, exist_ok=True)

                              # Write file
                              if 'value' in content and content['value']:
                                  file_path.write_text(content['value'], encoding='utf-8')
                              elif 'attachment' in content and content['attachment']:
                                  file_path.write_bytes(base64.b64decode(content['attachment']))

                      except Exception as e:
                          print(f"‚ö†Ô∏è  Error descargando {key}: {e}")

                  print("‚úÖ Descarga completada")

          except urllib.error.HTTPError as e:
              print(f"‚ùå Error HTTP {e.code}: {e.read().decode()}")
              exit(1)
          except Exception as e:
              print(f"‚ùå Error: {e}")
              exit(1)

          PYTHON_SCRIPT

      - name: Check for changes
        id: check_changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Cambios detectados desde Shopify"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No hay cambios nuevos"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "ü§ñ Auto-sync: Cambios desde Shopify ($(date +'%Y-%m-%d %H:%M:%S'))"
          git push
